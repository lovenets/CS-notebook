不管是 OSI 七层模型还是更常见的五层模型，IP 协议都位于网络层，这一层主要由 IP（Internet Protocol）和 ICMP（Internet Control Message Protocol）这两个协议组成。

# 网络层与数据链路层的关系

数据链路层提供==直连两个设备之间==的通信功能，网络层负责在==没有直连的两个网络之间==进行通信。

# 基础知识

## IP 地址

### IP 地址是网络层地址

1.在 TCP/IP 通信中的所有主机或者路由器必须设置自己的 IP 地址，用于连接到网络中的所有主机识别出进行通信的目的地址。

> 严格地讲，主机的定义是指“配置有 IP 地址，但是不进行路由控制的计算机”，既有 IP 地址又有路由控制能力的设备叫做路由器。

2.在网桥或者交换器等物理层或者数据链路层数据包转发设备中，不需要设置 IP 地址，因为这些设备只负责将 IP 数据包转换为比特流或者对数据链路帧的数据部分进行转发。

### IP 地址的定义

IPv4 地址由32位正整数组成，按照人类的读写习惯将32位的 IPv4 地址划分为8位一组，每组以“.”隔开，再将每组数转换为十进制数。

````
10101100 00010100 00000001 0000001
172. 20. 1. 1
````

### 网络地址和主机地址

IP 地址由网络地址和主机地址两部分组成。

- 网络地址必须保证相互连接的每个网段的地址不相重复，相同段内的所有相连主机必须有相同的网络地址
- 主机地址不允许在同一个网段内重复出现

### IP 地址的分类

![IP 地址分类](img\IP 地址分类.jpg)

- A类：0.0.0.0~127.0.0.0
- B类：128.0.0.1~191.255.0.0
- C类：192.168.0.0~239.255.255.0
- D类：224.0.0.0~239.255.255.255

分配网络地址时，主机地址不可以全为0或者全为1，全部为1的主机地址通常作为广播地址，全部为0的主机地址只有在表示对应的网络地址或者 IP 地址不可知的情况下才能使用。

### 广播地址

广播地址就是主机地址全为1的地址。

#### 1. 本地广播

![本地广播](img\本地广播.jpg)

#### 2. 直接广播

![直接广播](img\直接广播.jpg)

### IP 多播

多播是指将数据包发送给特定组内的所有主机。

#### 1. 多播地址

多播使用 D 类地址，因此从前4位是1110的 IP 地址就可以认为是多播地址。常见多播地址如下：

![多播地址](img\多播地址.jpg)

#### 2. 作用

多播的作用是提高发送效率，如果使用广播，收到数据的主机还需判断数据是否是发给自己的，多播则不必判断。

### 子网掩码

#### 1. 作用

（1）随着互联网的发展，IP 地址会不够用，直接使用 A 类、B 类或 C 类地址都会造成浪费。比如说 B 类网络理论上允许一个链路上最多存在65000多台计算机，但实际上这是不可能的。引入子网掩码可以带来更小的划分粒度。

（2）通过子网掩码与 IP 地址可以得出网络地址，如果网络地址相同，表明接受方在本网络上，那么可以通过相关的协议把数据包直接发送到目标主机；如果网络地址不同，表明目标主机在远程网络上，那么数据包将会发送给本网络上的路由器，由路由器将数据包发送到其他网络，直至到达目的地。

#### 2. 表示方法

将一个 IP 地址的网络部分全部置1，主机部分全部置0即得到子网掩码。引入子网掩码后 IP 地址可表示位“172.20.100.52/26”，意味着前26位是网络地址。

#### 3. 应用

（1）计算网络地址

- 将 IP 地址与子网掩码转换成二进制；

- 将二进制形式的 IP 地址与子网掩码做 ' 与 ' 运算，将答案化为十进制便得到网络地址；

（2）计算主机地址

- 将二进制形式的子网掩码取 ' 反 ' ；

- 将取 ' 反 ' 后的子网掩码与 IP 地址做 ' 与 ' 运算，将答案化为十进制便得到主机地址。

## 路由控制

路由控制（Routing）就是不管网络的结构如何复杂，分组数据都能到达最终目标地址。

### 跳（Hop）

一跳（1 Hop）是指利用数据链路层以下分层的功能传输数据帧的一个区间。数据链路层中一跳是指从源 MAC 地址到目标 MAC 地址之间传输帧的区间。这一跳的主机或者==路由器网卡==之间都是可以直接到达的，不会通过路由器或者网关相连。

多跳路由是指路由器或者主机在转发 IP 数据包时只指定了下一个路由或者主机，而不是将到最终目标地址为止的所有通路都指定出来。

### 路由控制表

所有主机都维护着一张自己的路由控制表（Routing Table），记录了 IP 数据在下一步应该发送给哪个路由器。

如果表中存在多个相同网络地址的记录，就选择相同位数最多的网络地址。比如172.20.100.52的网络地址与172.20/16和172.20.100/24都匹配，那么就应该选择位数更多的172.20.100/24。

![由控制表](img\路由控制表.jpg)

### 路由控制表的聚合

![路由表的聚合](img\路由表的聚合.jpg)

## 对数据链路层进行抽象

不同数据链路层（比如 LAN、PPP）有个最大的区别，就是它们各自的最大传输单位不同。为了解决这个问题，IP 协议会将较大的 IP 包切分成多个较小的包；分片的包到了对端目标地址之后再组装起来传给上一层。

## IP 面向无连接

面向无连接意味着即使对端主机关机甚至不存在，数据包还是被发送出去；而每一台主机也无法预先知道会何时从哪里受到数据。

面向无连接意味着不可靠，因为主机可能会错过一些该接收的包。但是面向无连接的设计的好处是简化和提速。

> TCP 面向有连接，需要事先建立连接才能通信，保证可靠通信。

## IPv6

IPv6 是为了从根本上解决 IPv4 地址耗尽的问题而出现的。

### 表示方法

IPv6 地址长度是128位，一般每16位作为一组，每组之间用“：”隔开。因为是16位一组，所以通常用16进制数表达。

```
fe80::3904:523c:cbf0:981b
```

如果地址中出现连续的0，那么可以用省略所有的0然后用“::”代替，但是一个 IPv6 地址中只允许出现一次两个连续的冒号。

### 结构

与 IPv4 类似，也是通过地址的前几位标识地址的种类。

![IPv6 结构](img\IPv6 结构.jpg)

# 首部

## IPv4 首部

![IPv4 首部](img\IPv4 首部.jpg)

## IPv6 首部

![IPv6 首部](img\IPv6 首部.jpg)

