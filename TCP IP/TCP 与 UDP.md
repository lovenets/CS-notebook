# 传输层的作用

## 通信处理

传输层的作用就是将从网络层获取的数据包发送给相应的程序进行处理。

![通信处理](img\通信处理.jpg)

## TCP 与 UDP 的区分

TCP 与 UDP 是传输层最重要的两个协议。

- TCP 用在传输层有必要实现==可靠传输==的情况。
- UDP 用于对高速传输和实时性有较高要求的通信或广播通信。

## socket

应用在使用 TCP 或者 UDP 时会广泛使用到 socket API，应用程序利用 socket 可以设置对端的 IP 地址、端口号，并实现数据的发送与接收。

![socket](img\socket.jpg)

## 端口

传输层协议利用端口号识别本机中正在进行通信的应用程序，准确地数据传输。

### 端口号的分配

#### 1. 静态方法

每个应用程序都有其指定的端口号，但并不是随意地使用任何一个端口。比如知名端口号。

#### 2. 时序分配法

服务端要确定监听端口号，客户端应用程序的端口号由操作系统进行分配。例如没需要一个新的端口号时就在之前的分配的端口号的基础上加1。

### 端口号与协议

1. 知名端口号与传输层协议无关
2. 不同的传输协议可以使用相同的端口号，例如 TCP 与 UDP 使用同一个端口，数据到达 IP 层之后会先检查 IP 首部的协议号，再传给相应的模块。这样即使是相同的端口号，彼此之间也不会受影响。

# UDP

UDP 是 User Datagram Protocol 的缩写。

## 特点

1. 不提供复杂的控制机制，利用 IP 提供面向无连接的服务，不提供可靠传输。
2. 随时发送数据，但不负责重发。
3. 不能进行流量控制。

## 用途

1. 数据包总量较少的通信（DNS、SNMP 等）

2. 视频、音频等即时通信
3. 限定于 LAN 等特定网络中的应用通信
4. 广播通信

# TCP

TCP 提供可靠通信，通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

## 序列号与确认应答

1. 当发送端的数据到达接收端的主机时，接收到要发送一个确认应答（ACK），通知发送端消息已收到
2. 发送端发送的数据的 TCP 首部中包含一个序列号和数据长度，接收端查询接收到的序列号和数据长度，将下一步应该接受的序列号作为确认应答返送回去。

![序列号](img\序列号.jpg)

## 重发超时

重发超时是指在重发数据之前应该等待确认应答到来的时间。如果超过这个时间才会重发。

重发时间比数据包往返时间和偏差总和稍大。重发时间的计算既要考虑往返时间又要偏差是因为网络环境的变化会导致往返时间产生较大的摇摆。如果考虑了偏差，就能尽量避免浪费网络流量。

数据被重发之后如果还是收不到确认应答，那么重发时间会以2倍、4倍的速率增长。但是数据也不能无限次重发，如果在重发一定次数之后还是没有确认，那么就会判断为网络或对端主机发生了异常，强制关闭连接。

## 连接管理

三次握手+四次挥手，一个 TCP 连接的建立与断开，正常情况下需要来回发送7个数据包。

![连接管理](img\连接管理.jpg)

## 利用窗口提高速度

TCP 以段（segment）为单位发送数据，每发送一个段就要进行一次确认，当数据包的往返时间较长时通信性能就会较低。

为此 TCP 引入窗口，窗口大小是指无需等待确认应答就可以继续发送数据的最大值。引入窗口之后发送端就可以并行地发送多个段，只要这些段加起来地数据总量没有超过窗口大小。

### 滑动窗口

![滑动窗口](img\滑动窗口.jpg)

在滑动窗口以外的数据包括已被确认的数据和尚未发送的数据。收到确认应答的情况下将滑动窗口移动到确认应答中的序列号的位置，这样就可以顺序将多个段同时发送。

### 重发控制

（1）报文段丢失的情况

![报文段丢失时的重发控制](img\报文段丢失时的重发控制.jpg)

（2）确认应答丢失的情况

![确认应答丢失时的重发控制](img\确认应答丢失时的重发控制.jpg)

## 流控制

为了防止发送端发送数据过大导致接收端超负荷等情况，接收端会主动向发送端通知自己可以接收数据的大小，这个大小叫做窗口大小。TCP 首部中有一个字段用来通知窗口大小，这个值越大说明网络吞吐量越好。如果接收端的缓冲区（也就是窗口大小）面临数据溢出，窗口大小就会减小并通知发送端。

![流控制](img\流控制.jpg)

## 拥塞控制

TCP会为每条连接维护一个“拥塞窗口”来限制可能在端对端间传输的未确认分组总数量。这类似TCP流量控制机制中使用的滑动窗口。TCP在一个连接初始化或超时后使用一种“慢启动”机制来增加拥塞窗口的大小，它的起始值一般为最大分段大小（Maximum segment size，MSS）的两倍，虽然名为“慢启动”，初始值也相当低，但其增长极快：当每个分段得到确认时，拥塞窗口会增加一个MSS，使得在每次往返时间（round-trip time，RTT）内拥塞窗口能高效地双倍增长。

### 拥塞窗口

由发送方维护，通过估计链路的拥塞程度计算出来，与由接收方维护的接收窗口大小并不冲突。

发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。

### 慢启动

慢启动初始启动时设置拥塞窗口值（cwnd）为1、2、4或10个 MSS。拥塞窗口在每接收到一个确认包时增加，每个 RTT 内成倍增加，当然实际上并不完全是指数增长，因为接收方会延迟发送确认，通常是每接收两个分段则发送一次确认包。发送速率随着慢启动的进行而增加，直到遇到出现丢失、达到慢启动阈值（ssthresh）、或者接收方的接收窗口进行限制。

当达到慢启动阈值（ssthresh）时，慢启动算法就会转换为线性增长的阶段，算法控制每个RTT内拥塞窗口只增加1个分段量。

![慢开始](img\慢开始.jpg)

### 快重传

![快重传](img\快重传.jpg)

### 快速恢复

![快速恢复](img\快速恢复.jpg)

